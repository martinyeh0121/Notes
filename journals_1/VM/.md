

deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
deb https://enterprise.proxmox.com/debian/ceph-quincy bookworm enterprise

``` sh
# 註解掉 PVE enterprise source
sed -i 's|^deb https://enterprise.proxmox.com|# deb https://enterprise.proxmox.com|' /etc/apt/sources.list.d/pve-enterprise.list

# 加入 PVE no-subscription source
echo "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription" | sudo tee -a /etc/apt/sources.list

# 修改 Ceph source 為 no-subscription 
sed -i 's|https://enterprise.proxmox.com|http://download.proxmox.com|g; s|enterprise|no-subscription|g' /etc/apt/sources.list.d/ceph.list

# 更新套件清單
apt update
```

[iso_desk](https://releases.ubuntu.com/jammy/ubuntu-22.04.5-desktop-amd64.iso)
[iso_srv](https://releases.ubuntu.com/jammy/ubuntu-22.04.5-live-server-amd64.iso)


``` log
starting file import from: /var/tmp/pveupload-5b0997f67ccf5c65f74b7bc110946b80
target node: mbpc220908
target file: /var/lib/vz/template/iso/ubuntu-22.04.5-live-server-amd64.iso
file size is: 2136926208
command: cp -- /var/tmp/pveupload-5b0997f67ccf5c65f74b7bc110946b80 /var/lib/vz/template/iso/ubuntu-22.04.5-live-server-amd64.iso
finished file import successfully
TASK OK

```
## setting
6.x - 2.6 Kernel
ubuntu-22.04.5-live-server-amd64.iso

SPICE
q35

## command
qm stop <VMID>



## VM 建置

cloud init

passwd: openssl rand -base64 12

``` sh
#!/bin/bash

# 檢查參數
if [ "$#" -lt 2 ]; then
  echo "❌ 用法: $0 <vm_name/username> <password>"
  exit 1
fi

# === 參數設定 ===
VMID=$1
VM_NAME="$2"
CI_USER="$2"
CI_PASS="$3"

NODE="mbpc220908"
ISO_STORAGE="local"
ISO_FILE="iso/ubuntu-22.04.5-live-server-amd64.iso"
DISK_STORAGE="local-lvm"
BRIDGE="vmbr0"

# === 創建 VM ===
echo "🛠 Creating VM $VMID ($VM_NAME)..."
qm create $VMID \
  --name "$VM_NAME" \
  --memory 2048 \
  --cores 2 \
  --cpu "x86-64-v2-AES" \
  --machine q35 \
  --net0 virtio,bridge=$BRIDGE \
  --scsihw virtio-scsi-pci \
  --scsi0 $DISK_STORAGE:32 \
  --ide2 $ISO_STORAGE:$ISO_FILE,media=cdrom \
  --boot order=scsi0;ide2 \
  --vga qxl \
  --ostype l26 \
  --agent enabled=1 \
  --description "Ubuntu 22.04 VM with Cloud-Init (no network config)"

# === 加 Cloud-Init Drive ===
echo "💾 Adding Cloud-Init drive..."
qm set $VMID --ide3 $DISK_STORAGE:cloudinit

# === 設定 Cloud-Init 使用者和密碼 ===
echo "🔐 Setting Cloud-Init credentials..."
qm set $VMID --ciuser "$CI_USER" --cipassword "$CI_PASS"

# ❌ 不設定 IP / DHCP / 網路介面
# ✅ Cloud-Init 會忽略網路設定，讓 VM 使用預設方式或由你手動設定

# === 重新產生 Cloud-Init 映像 ===
qm cloudinit regenerate $VMID

# === 啟動 VM ===
echo "🚀 Starting VM $VMID..."
qm start $VMID

echo "✅ VM $VMID ($VM_NAME) created and started without network config."

```

## 網路設定

``` sh
#!/bin/bash
# echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward 

# sudo nano /etc/sysctl.conf -> 加上 net.ipv4.ip_forward=1 -> sudo sysctl -p

# grep -q '^net.ipv4.ip_forward' /etc/sysctl.conf  # (啟用 IP forwarding)
grep -q '^net.ipv4.ip_forward' /etc/sysctl.conf || echo 'net.ipv4.ip_forward=1' | tee -a /etc/sysctl.conf


# 網卡名稱（請改成你節點的外網網卡）
WAN_IFACE="eth0"

# VM 的內部網段（如 vmbr1 使用的子網）
VM_SUBNET="192.168.100.0/24"

echo "🛠️ 啟用 IP forwarding..."
sed -i 's/^#\?net.ipv4.ip_forward=.*/net.ipv4.ip_forward=1/' /etc/sysctl.conf
sysctl -p

echo "🔧 設定 NAT 規則：$VM_SUBNET -> $WAN_IFACE"
sudo iptables -t nat -A POSTROUTING -s $VM_SUBNET -o $WAN_IFACE -j MASQUERADE
sudo iptables -A FORWARD -i vmbr1 -o $WAN_IFACE -j ACCEPT
sudo iptables -A FORWARD -i $WAN_IFACE -o vmbr1 -m state --state ESTABLISHED,RELATED -j ACCEPT

echo "💾 儲存 iptables 規則（請確認已安裝 iptables-persistent）"
sudo apt-get install -y iptables-persistent
sudo netfilter-persistent save

echo "✅ NAT 設定完成"
```

``` sh
#!/bin/bash

# 網卡名稱（請改成你節點的外網網卡）
WAN_IFACE="eth0"

# VM 的內部網段（如 vmbr1 使用的子網）
VM_SUBNET="192.168.100.0/24"

echo "🛠️ 啟用 IP forwarding..."
sudo sed -i 's/^#\?net.ipv4.ip_forward=.*/net.ipv4.ip_forward=1/' /etc/sysctl.conf
sudo sysctl -p

echo "🔧 設定 NAT 規則：$VM_SUBNET -> $WAN_IFACE"
sudo iptables -t nat -A POSTROUTING -s $VM_SUBNET -o $WAN_IFACE -j MASQUERADE
sudo iptables -A FORWARD -i vmbr1 -o $WAN_IFACE -j ACCEPT
sudo iptables -A FORWARD -i $WAN_IFACE -o vmbr1 -m state --state ESTABLISHED,RELATED -j ACCEPT

echo "💾 儲存 iptables 規則（請確認已安裝 iptables-persistent）"
sudo apt-get install -y iptables-persistent
sudo netfilter-persistent save

echo "✅ NAT 設定完成"
```

