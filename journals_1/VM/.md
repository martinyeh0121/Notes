

deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
deb https://enterprise.proxmox.com/debian/ceph-quincy bookworm enterprise

``` sh
# è¨»è§£æ‰ PVE enterprise source
sed -i 's|^deb https://enterprise.proxmox.com|# deb https://enterprise.proxmox.com|' /etc/apt/sources.list.d/pve-enterprise.list

# åŠ å…¥ PVE no-subscription source
echo "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription" | sudo tee -a /etc/apt/sources.list

# ä¿®æ”¹ Ceph source ç‚º no-subscription 
sed -i 's|https://enterprise.proxmox.com|http://download.proxmox.com|g; s|enterprise|no-subscription|g' /etc/apt/sources.list.d/ceph.list

# æ›´æ–°å¥—ä»¶æ¸…å–®
apt update
```

[iso_desk](https://releases.ubuntu.com/jammy/ubuntu-22.04.5-desktop-amd64.iso)
[iso_srv](https://releases.ubuntu.com/jammy/ubuntu-22.04.5-live-server-amd64.iso)


``` log
starting file import from: /var/tmp/pveupload-5b0997f67ccf5c65f74b7bc110946b80
target node: mbpc220908
target file: /var/lib/vz/template/iso/ubuntu-22.04.5-live-server-amd64.iso
file size is: 2136926208
command: cp -- /var/tmp/pveupload-5b0997f67ccf5c65f74b7bc110946b80 /var/lib/vz/template/iso/ubuntu-22.04.5-live-server-amd64.iso
finished file import successfully
TASK OK

```
## setting
6.x - 2.6 Kernel
ubuntu-22.04.5-live-server-amd64.iso

SPICE
q35

## command
qm stop <VMID>



## VM å»ºç½®

cloud init

passwd: openssl rand -base64 12

``` sh
#!/bin/bash

# æª¢æŸ¥åƒæ•¸
if [ "$#" -lt 2 ]; then
  echo "âŒ ç”¨æ³•: $0 <vm_name/username> <password>"
  exit 1
fi

# === åƒæ•¸è¨­å®š ===
VMID=$1
VM_NAME="$2"
CI_USER="$2"
CI_PASS="$3"

NODE="mbpc220908"
ISO_STORAGE="local"
ISO_FILE="iso/ubuntu-22.04.5-live-server-amd64.iso"
DISK_STORAGE="local-lvm"
BRIDGE="vmbr0"

# === å‰µå»º VM ===
echo "ğŸ›  Creating VM $VMID ($VM_NAME)..."
qm create $VMID \
  --name "$VM_NAME" \
  --memory 2048 \
  --cores 2 \
  --cpu "x86-64-v2-AES" \
  --machine q35 \
  --net0 virtio,bridge=$BRIDGE \
  --scsihw virtio-scsi-pci \
  --scsi0 $DISK_STORAGE:32 \
  --ide2 $ISO_STORAGE:$ISO_FILE,media=cdrom \
  --boot order=scsi0;ide2 \
  --vga qxl \
  --ostype l26 \
  --agent enabled=1 \
  --description "Ubuntu 22.04 VM with Cloud-Init (no network config)"

# === åŠ  Cloud-Init Drive ===
echo "ğŸ’¾ Adding Cloud-Init drive..."
qm set $VMID --ide3 $DISK_STORAGE:cloudinit

# === è¨­å®š Cloud-Init ä½¿ç”¨è€…å’Œå¯†ç¢¼ ===
echo "ğŸ” Setting Cloud-Init credentials..."
qm set $VMID --ciuser "$CI_USER" --cipassword "$CI_PASS"

# âŒ ä¸è¨­å®š IP / DHCP / ç¶²è·¯ä»‹é¢
# âœ… Cloud-Init æœƒå¿½ç•¥ç¶²è·¯è¨­å®šï¼Œè®“ VM ä½¿ç”¨é è¨­æ–¹å¼æˆ–ç”±ä½ æ‰‹å‹•è¨­å®š

# === é‡æ–°ç”¢ç”Ÿ Cloud-Init æ˜ åƒ ===
qm cloudinit regenerate $VMID

# === å•Ÿå‹• VM ===
echo "ğŸš€ Starting VM $VMID..."
qm start $VMID

echo "âœ… VM $VMID ($VM_NAME) created and started without network config."

```

## ç¶²è·¯è¨­å®š

``` sh
#!/bin/bash
# echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward 

# sudo nano /etc/sysctl.conf -> åŠ ä¸Š net.ipv4.ip_forward=1 -> sudo sysctl -p

# grep -q '^net.ipv4.ip_forward' /etc/sysctl.conf  # (å•Ÿç”¨ IP forwarding)
grep -q '^net.ipv4.ip_forward' /etc/sysctl.conf || echo 'net.ipv4.ip_forward=1' | tee -a /etc/sysctl.conf


# ç¶²å¡åç¨±ï¼ˆè«‹æ”¹æˆä½ ç¯€é»çš„å¤–ç¶²ç¶²å¡ï¼‰
WAN_IFACE="eth0"

# VM çš„å…§éƒ¨ç¶²æ®µï¼ˆå¦‚ vmbr1 ä½¿ç”¨çš„å­ç¶²ï¼‰
VM_SUBNET="192.168.100.0/24"

echo "ğŸ› ï¸ å•Ÿç”¨ IP forwarding..."
sed -i 's/^#\?net.ipv4.ip_forward=.*/net.ipv4.ip_forward=1/' /etc/sysctl.conf
sysctl -p

echo "ğŸ”§ è¨­å®š NAT è¦å‰‡ï¼š$VM_SUBNET -> $WAN_IFACE"
sudo iptables -t nat -A POSTROUTING -s $VM_SUBNET -o $WAN_IFACE -j MASQUERADE
sudo iptables -A FORWARD -i vmbr1 -o $WAN_IFACE -j ACCEPT
sudo iptables -A FORWARD -i $WAN_IFACE -o vmbr1 -m state --state ESTABLISHED,RELATED -j ACCEPT

echo "ğŸ’¾ å„²å­˜ iptables è¦å‰‡ï¼ˆè«‹ç¢ºèªå·²å®‰è£ iptables-persistentï¼‰"
sudo apt-get install -y iptables-persistent
sudo netfilter-persistent save

echo "âœ… NAT è¨­å®šå®Œæˆ"
```

``` sh
#!/bin/bash

# ç¶²å¡åç¨±ï¼ˆè«‹æ”¹æˆä½ ç¯€é»çš„å¤–ç¶²ç¶²å¡ï¼‰
WAN_IFACE="eth0"

# VM çš„å…§éƒ¨ç¶²æ®µï¼ˆå¦‚ vmbr1 ä½¿ç”¨çš„å­ç¶²ï¼‰
VM_SUBNET="192.168.100.0/24"

echo "ğŸ› ï¸ å•Ÿç”¨ IP forwarding..."
sudo sed -i 's/^#\?net.ipv4.ip_forward=.*/net.ipv4.ip_forward=1/' /etc/sysctl.conf
sudo sysctl -p

echo "ğŸ”§ è¨­å®š NAT è¦å‰‡ï¼š$VM_SUBNET -> $WAN_IFACE"
sudo iptables -t nat -A POSTROUTING -s $VM_SUBNET -o $WAN_IFACE -j MASQUERADE
sudo iptables -A FORWARD -i vmbr1 -o $WAN_IFACE -j ACCEPT
sudo iptables -A FORWARD -i $WAN_IFACE -o vmbr1 -m state --state ESTABLISHED,RELATED -j ACCEPT

echo "ğŸ’¾ å„²å­˜ iptables è¦å‰‡ï¼ˆè«‹ç¢ºèªå·²å®‰è£ iptables-persistentï¼‰"
sudo apt-get install -y iptables-persistent
sudo netfilter-persistent save

echo "âœ… NAT è¨­å®šå®Œæˆ"
```

