

![alt text](image.png)

- ä»¥ä¸‹æœªæåŠ console (vm ä¹‹console) ä¹‹æŒ‡ä»¤çš†é è¨­æ–¼ node ä¹‹ shell åŸ·è¡Œ 
## vm å»ºç«‹
æ‰‹å‹•é…ç½®è³‡æº or ä½¿ç”¨ cil script (é‚„æ²’èª¿å¥½ï¼Œscriptèƒ½å®Œæˆ vm å»ºç«‹ + ubuntu å®‰è£)

### cli 

``` sh
# cloud init

# passwd: openssl rand -base64 12

#!/bin/bash

# æª¢æŸ¥åƒæ•¸
if [ "$#" -lt 2 ]; then
  echo "âŒ ç”¨æ³•: $0 <vm_name/username> <password>"
  exit 1
fi

# === åƒæ•¸è¨­å®š ===
VMID=$1
VM_NAME="$2"
CI_USER="$2"
CI_PASS="$3"

NODE="mbpc220908"
ISO_STORAGE="local"
ISO_FILE="iso/ubuntu-22.04.5-live-server-amd64.iso"
DISK_STORAGE="local-lvm"
BRIDGE="vmbr0"

# === å‰µå»º VM ===
echo "ğŸ›  Creating VM $VMID ($VM_NAME)..."
qm create $VMID \
  --name "$VM_NAME" \
  --memory 2048 \
  --cores 2 \
  --cpu "x86-64-v2-AES" \
  --machine q35 \
  --net0 virtio,bridge=$BRIDGE \
  --scsihw virtio-scsi-pci \
  --scsi0 $DISK_STORAGE:32 \
  --ide2 $ISO_STORAGE:$ISO_FILE,media=cdrom \
  --boot order=scsi0;ide2 \
  --vga qxl \
  --ostype l26 \
  --agent enabled=1 \
  --description "Ubuntu 22.04 VM with Cloud-Init (no network config)"

# === åŠ  Cloud-Init Drive ===
echo "ğŸ’¾ Adding Cloud-Init drive..."
qm set $VMID --ide3 $DISK_STORAGE:cloudinit

# === è¨­å®š Cloud-Init ä½¿ç”¨è€…å’Œå¯†ç¢¼ ===
echo "ğŸ” Setting Cloud-Init credentials..."
qm set $VMID --ciuser "$CI_USER" --cipassword "$CI_PASS"

# âŒ ä¸è¨­å®š IP / DHCP / ç¶²è·¯ä»‹é¢
# âœ… Cloud-Init æœƒå¿½ç•¥ç¶²è·¯è¨­å®šï¼Œè®“ VM ä½¿ç”¨é è¨­æ–¹å¼æˆ–ç”±ä½ æ‰‹å‹•è¨­å®š

# === é‡æ–°ç”¢ç”Ÿ Cloud-Init æ˜ åƒ ===
qm cloudinit regenerate $VMID

# === å•Ÿå‹• VM ===
echo "ğŸš€ Starting VM $VMID..."
qm start $VMID

echo "âœ… VM $VMID ($VM_NAME) created and started without network config."
```

## ubuntu å®‰è£ (console)

## ssh è¨­å®š
``` sh
qm set 100 --sshkey /root/.ssh/id_rsa.pub
qm cloudinit update 100
qm set 100 --ciuser mbvm250603
qm reboot 100
ssh -i ~/.ssh/id_rsa mbvm250603@192.168.16.63 # sshé€£ç·š
# ssh -i ~/.ssh/id_rsa mbvm250604@192.168.16.64
```

### å¦‚isoè¨­å®šæ™‚æœªå®‰è£openssh-server ()
- ä½¿ç”¨console æ–¼ VM å®‰è£ openssh-serverï¼Œå®Œæˆå¾Œæ–¹èƒ½ç”¨ ssh æŒ‡ä»¤é€£ç·š
``` sh
sudo apt update
sudo apt install openssh-server
sudo systemctl enable --now ssh
```

## ip

ä¿®æ”¹node nano /etc/network/interfaces
``` sh
auto lo
iface lo inet loopback

iface enp5s0 inet manual

auto vmbr0
iface vmbr0 inet static
        address 192.168.16.62/24
        gateway 192.168.16.1
        bridge-ports enp5s0
        bridge-stp off
        bridge-fd 0

## æ–°å¢ç¶²å¡ vmbr1
auto vmbr1
iface vmbr1 inet static
        address 172.23.0.1/24
#        gateway 172.23.0.1  
        bridge-ports none  
        bridge-stp off
        bridge-fd 0

source /etc/network/interfaces.d/*
```

- æ”¹å®Œé‡å•Ÿç¶²å¡ï¼Œç¢ºèªvmbr1 æˆåŠŸæ–°å¢
``` bash
root@mbpc220908:~# systemctl restart networking

root@mbpc220908:~# ip a | grep "vmbr"
2: enp5s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq master vmbr0 state UP group default qlen 1000
31: vmbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    inet 192.168.16.62/24 scope global vmbr0
32: vmbr1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    inet 172.23.0.1/24 scope global vmbr1
```

- 1. è¨­å®šNAT è™•ç† å…§å¤–ç¶²ip è½‰æ›

iptables -t nat -A POSTROUTING -s 172.23.0.0/24 -o vmbr0 -j MASQUERADE


- **æ³¨æ„:ç¶²å¡è¨­å®šå®Œè¦é‡å•Ÿ**